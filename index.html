<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overpass-Turbo Query Explorer</title>

<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet" id="prism-theme-light">
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.css" rel="stylesheet" id="prism-theme-dark" disabled>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>

<style>
:root {
    --bg: #f5f5f5;
    --card-bg: #fff;
    --text: #111;
    --accent: #007acc;
}
[data-theme="dark"] {
    --bg: #121212;
    --card-bg: #1e1e1e;
    --text: #eee;
    --accent: #1e90ff;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 20px;
    transition: background 0.3s, color 0.3s;
}
h1 { text-align: center; margin-bottom: 20px; }
#themeToggle { position: fixed; top: 15px; right: 15px; background: var(--accent); color: #fff; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
#githubLink { position: fixed; top: 22px; right: 80px; color: var(--text); text-decoration: none; transition: transform 0.2s, color 0.3s; }
#githubLink:hover { transform: scale(1.1); color: var(--accent); }
[data-theme="dark"] #githubLink svg { fill: #eee; }
[data-theme="light"] #githubLink svg { fill: #111; }
input { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px; box-sizing: border-box; }
#tagFilters { margin-bottom: 20px; display:flex; flex-wrap:wrap; gap:8px; }
#tagFilters button { font-size: 0.9em; transition: transform 0.2s; }
#tagFilters button:hover { transform: scale(1.05); }
#tagFilters button.active { box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--accent); transform: scale(1.1); }

/* Contenitore principale */
#mainContainer {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    margin-top: 20px;
}

/* Lista query */
#queryList {
    display: grid;
    gap: 15px;
    grid-template-columns: 1fr;
    list-style: none; /* rimuove i pallini */
    padding: 0;
}
li { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
li:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
.tags { font-size: 0.85em; color: #555; margin-top: 5px; }

/* Dettaglio query */
#queryDetail {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: flex-start;
    background: var(--card-bg);
    padding: 15px;
    border-radius: 12px;
    min-height: 400px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
#queryDetail.empty {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #777;
    font-style: italic;
    font-size: 1.1em;
}
pre { border-radius: 12px; padding: 15px; max-height: 500px; overflow-x: auto; margin-top: 10px; }
button.openOverpass { 
    background: var(--accent); 
    color: white; 
    border: none; 
    padding: 6px 12px; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 14px; 
    margin-left: auto;
}
button.openOverpass:hover { background: #005fa3; }

/* Titolo + pulsante inline */
.queryHeader { display: flex; align-items: center; justify-content: space-between; }

@media (max-width: 900px) {
    #mainContainer {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 600px) {
    #githubLink, #themeToggle { position: static; display: inline-flex; margin: 0 5px; }
    header { text-align: center; margin-bottom: 15px; }
    header div { margin-top: 10px; }
    input { font-size: 14px; }
}
</style>
</head>
<body>

<header>
  <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px; flex-wrap:wrap;">
    <a id="githubLink" href="https://github.com/andrea-del-sarto/overpass-turbo_query_explorer" target="_blank" title="Apri su GitHub">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 .297a12 12 0 00-3.794 23.419c.6.111.793-.261.793-.579v-2.021c-3.338.726-4.042-1.416-4.042-1.416-.546-1.387-1.333-1.757-1.333-1.757-1.089-.745.083-.729.083-.729 1.205.084 1.84 1.236 1.84 1.236 1.07 1.834 2.809 1.304 3.495.997.108-.776.419-1.305.762-1.606-2.665-.304-5.466-1.333-5.466-5.931 0-1.311.469-2.382 1.236-3.222-.124-.303-.536-1.527.117-3.183 0 0 1.008-.322 3.3 1.23a11.52 11.52 0 016.004 0c2.292-1.552 3.3-1.23 3.3-1.23.653 1.656.241 2.88.118 3.183.768.84 1.236 1.911 1.236 3.222 0 4.609-2.803 5.625-5.475 5.922.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.577A12.004 12.004 0 0012 .297z"/>
      </svg>
    </a>
    <button id="themeToggle" title="Cambia tema">
      <span id="themeIcon"></span>
    </button>
  </div>
  <h1>Overpass-Turbo Query Explorer</h1>
</header>

<input type="text" id="search" placeholder="Cerca per tag o nome della query...">
<div id="tagFilters"></div>

<div id="mainContainer">
    <ul id="queryList"></ul>
    <div id="queryDetail" class="empty">Seleziona una query per visualizzarla</div>
</div>

<script>
const queryList = document.getElementById("queryList");
const searchInput = document.getElementById("search");
const queryDetail = document.getElementById("queryDetail");
const tagFilters = document.getElementById("tagFilters");

let queries = [];
let activeTags = [];

// --- Carica queries da JSON ---
async function loadQueries() {
    const response = await fetch('queries/queries.json');
    queries = await response.json();
    renderList();
    renderTagButtons();
}

// --- Lista query filtrata per ricerca e tag ---
function renderList(filter="", activeTagsParam=activeTags) {
    queryList.innerHTML = "";
    const filtered = queries.filter(q => {
        const matchText = q.name.toLowerCase().includes(filter) || q.tags.some(tag => tag.toLowerCase().includes(filter));
        const matchTags = activeTagsParam.length === 0 || q.tags.some(tag => activeTagsParam.includes(tag.toLowerCase()));
        return matchText && matchTags;
    });
    filtered.forEach(q => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${q.name}</strong>
                        <div class="tags">Tags: ${q.tags.join(", ")}</div>`;
        li.addEventListener("click", () => loadQuery(q));
        queryList.appendChild(li);
    });
}

// --- Carica query singola ---
async function loadQuery(q) {
    const response = await fetch(`queries/${q.file}`);
    const code = await response.text();
    queryDetail.classList.remove("empty");
    queryDetail.innerHTML = `
        <div class="queryHeader">
            <h2 id="queryName">${q.name}</h2>
            <button class="openOverpass" id="openOverpass">Apri in Overpass Turbo</button>
        </div>
        <pre><code id="queryCode" class="language-bash"></code></pre>
    `;
    document.getElementById("queryCode").textContent = code;
    Prism.highlightElement(document.getElementById("queryCode"));
    document.getElementById("openOverpass").onclick = () => {
        const url = "https://overpass-turbo.eu/?Q=" + encodeURIComponent(code);
        window.open(url, "_blank");
    };
}

// --- Ricerca ---
searchInput.addEventListener("input", e => {
    queryDetail.innerHTML = "Seleziona una query per visualizzarla";
    queryDetail.classList.add("empty");
    renderList(e.target.value.toLowerCase());
});

// --- Pulsanti tag multi-selezione ---
function renderTagButtons() {
    const allTags = [...new Set(queries.flatMap(q => q.tags))];
    tagFilters.innerHTML = "";

    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Tutti";
    resetBtn.style.background = "#888";
    resetBtn.style.color = "#fff";
    resetBtn.style.border = "none";
    resetBtn.style.borderRadius = "8px";
    resetBtn.style.padding = "6px 12px";
    resetBtn.style.cursor = "pointer";
    resetBtn.classList.add("active");
    resetBtn.addEventListener("click", () => {
        activeTags = [];
        queryDetail.innerHTML = "Seleziona una query per visualizzarla";
        queryDetail.classList.add("empty");
        renderList(searchInput.value.toLowerCase());
        document.querySelectorAll("#tagFilters button").forEach(btn => btn.classList.remove("active"));
        resetBtn.classList.add("active");
    });
    tagFilters.appendChild(resetBtn);

    allTags.forEach(tag => {
        const btn = document.createElement("button");
        btn.textContent = tag;
        btn.style.background = "var(--accent)";
        btn.style.color = "#fff";
        btn.style.border = "none";
        btn.style.borderRadius = "8px";
        btn.style.padding = "6px 12px";
        btn.style.cursor = "pointer";

        btn.addEventListener("click", () => {
            const tagLower = tag.toLowerCase();
            if(activeTags.includes(tagLower)) {
                activeTags = activeTags.filter(t => t !== tagLower);
                btn.classList.remove("active");
            } else {
                activeTags.push(tagLower);
                btn.classList.add("active");
            }
            if(activeTags.length > 0) resetBtn.classList.remove("active");
            else resetBtn.classList.add("active");
            queryDetail.innerHTML = "Seleziona una query per visualizzarla";
            queryDetail.classList.add("empty");
            renderList(searchInput.value.toLowerCase());
        });
        tagFilters.appendChild(btn);
    });
}

// --- Tema chiaro/scuro ---
const themeToggle = document.getElementById("themeToggle");
const themeIcon = document.getElementById("themeIcon");

function getSunIcon(){ return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.48 0l1.79-1.8-1.41-1.41-1.8 1.79 1.42 1.42zM12 4V1h-1v3h1zm0 19v-3h-1v3h1zm8.66-11h3v-1h-3v1zm-19.32 0h3v-1h-3v1zm15.9 7.66l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zm-12.02 0l-1.8 1.79 1.41 1.41 1.79-1.8-1.4-1.4zM12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>`; }
function getMoonIcon(){ return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>`; }

function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    document.getElementById("prism-theme-light").disabled = theme === "dark";
    document.getElementById("prism-theme-dark").disabled = theme === "light";
    themeIcon.innerHTML = theme === "dark" ? getSunIcon() : getMoonIcon();
}

let currentTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
applyTheme(currentTheme);

themeToggle.addEventListener("click", ()=>{
    currentTheme = currentTheme==="dark" ? "light" : "dark";
    applyTheme(currentTheme);
});

window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", e=>{
    currentTheme = e.matches ? "dark" : "light";
    applyTheme(currentTheme);
});

// --- Inizializza ---
loadQueries();
</script>

</body>
</html>
